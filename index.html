<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Player de M√∫sica</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 2rem;
    background: var(--bg-color);
    color: var(--text-color);
    transition: background 0.3s, color 0.3s;
  }
  :root {
    --bg-color: #f7f7f7;
    --text-color: #333;
    --card-bg: #fff;
    --highlight: #d0eaff;
  }
  body.dark {
    --bg-color: #1e1e1e;
    --text-color: #eee;
    --card-bg: #2c2c2c;
    --highlight: #3a4d5c;
  }
  h2 {
    text-align: center;
    color: var(--text-color);
  }
  #controls {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-top: 1rem;
  }
  input, button {
    padding: 0.5rem;
    border-radius: 5px;
    border: 1px solid #ccc;
    background: var(--card-bg);
    color: var(--text-color);
  }
  button {
    cursor: pointer;
    border: none;
  }
  button.action {
    background: #0078ff;
    color: white;
  }
  button.action:hover {
    background: #005fc0;
  }
  #playlist {
    margin-top: 1.5rem;
    background: var(--card-bg);
    border-radius: 8px;
    padding: 0.5rem;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
  }
  .song {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px;
    border-bottom: 1px solid #5553;
    cursor: pointer;
    transition: background 0.2s;
  }
  .song:hover {
    background: var(--highlight);
  }
  .song img {
    width: 60px;
    height: 45px;
    object-fit: cover;
    border-radius: 4px;
  }
  .song .info {
    flex: 1;
  }
  .song .title {
    font-weight: bold;
    font-size: 14px;
  }
  .song .duration {
    font-size: 12px;
    opacity: 0.7;
  }
  .current {
    background: var(--highlight);
    font-weight: bold;
  }
  #top-bar {
    display: flex;
    justify-content: flex-end;
    gap: 0.5rem;
  }
  #progress-bar-container {
    width: 100%;
    max-width: 500px;
    margin: 0 auto 14px auto;
    display: flex;
    align-items: center;
    gap: 12px;
    background: var(--card-bg);
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.07);
    padding: 0.5rem 1rem;
    margin-top: 1rem;
    justify-content: center;
  }
  #progress-bar {
    flex: 1;
    height: 6px;
    background: #ddd;
    border-radius: 4px;
    cursor: pointer;
    position: relative;
  }
  #progress-filled {
    background: #0078ff;
    height: 100%;
    border-radius: 4px;
    width: 0%;
    position: absolute;
    top: 0;
    left: 0;
  }
  #time-current, #time-duration {
    font-size: 13px;
    min-width: 45px;
    text-align: center;
  }
  #main-area {
    display: flex;
    flex-direction: column;
    align-items: center;
  }
  #input-section {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
  }
  #music-visualizer {
    display:block; 
    margin:0 auto 12px auto; 
    width:100%; 
    max-width:500px; 
    background:var(--card-bg); 
    border-radius:8px;
  }
</style>
</head>
<body>

<div id="top-bar">
  <button id="toggleTheme">üåô Modo Escuro</button>
</div>

<h2>üéµ Player de M√∫sica</h2>

<div id="main-area">
  <div id="input-section">
    <input type="text" id="inputLink" placeholder="Cole link do YouTube aqui" style="width: 300px;" />
    <button id="btnAdd" class="action">Adicionar</button>
  </div>

  <!-- Visualizador de m√∫sica -->
  <canvas id="music-visualizer" width="500" height="80"></canvas>

  <!-- Barra de progresso e tempo -->
  <div id="progress-bar-container">
    <span id="time-current">0:00</span>
    <div id="progress-bar">
      <div id="progress-filled"></div>
    </div>
    <span id="time-duration">0:00</span>
  </div>

  <div id="controls">
    <button id="btnPrev" class="action">‚èÆ Voltar</button>
    <button id="btnPlay" class="action">‚ñ∂ Play</button>
    <button id="btnPause" class="action">‚è∏ Pause</button>
    <button id="btnSkip" class="action">‚è≠ Avan√ßar</button>
    <button id="btnStop" class="action">‚èπ Parar</button>
  </div>
</div>

<!-- Removido o #player (tela do v√≠deo) -->
<div id="playlist"></div>

<script>
// ----------- Tema (Modo Escuro/Claro) -----------
function loadTheme() {
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark");
    document.getElementById("toggleTheme").textContent = "‚òÄ Modo Claro";
  }
}
function toggleTheme() {
  document.body.classList.toggle("dark");
  const isDark = document.body.classList.contains("dark");
  document.getElementById("toggleTheme").textContent = isDark ? "‚òÄ Modo Claro" : "üåô Modo Escuro";
  localStorage.setItem("theme", isDark ? "dark" : "light");
}
document.getElementById("toggleTheme").onclick = toggleTheme;
loadTheme();

// ----------- YouTube Player API (√°udio oculto) -----------
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
document.body.appendChild(tag);

let player;
let playlist = []; // [{id, title, duration, thumb}]
let currentIndex = 0;
let duration = 0;
let progressBarInterval;

function createHiddenPlayer() {
  // Cria um player invis√≠vel
  const div = document.createElement('div');
  div.id = 'player';
  div.style.display = 'none';
  document.body.appendChild(div);
}

createHiddenPlayer();

// ----------- Music Visualizer (fake bars) -----------
const visualizer = document.getElementById("music-visualizer");
const vctx = visualizer.getContext("2d");
let visAnimId = null;
let visActive = false;

function drawVisualizer(bars = 32) {
  // Responsivo
  const W = visualizer.width = visualizer.offsetWidth;
  const H = visualizer.height;
  vctx.clearRect(0, 0, W, H);

  for (let i = 0; i < bars; i++) {
    // Fake animation: use Math.sin + current time for effect
    const time = Date.now() / 700;
    // Animate based on playing state
    const amplitude = visActive ? (0.4 + 0.6 * Math.abs(Math.sin(time + i))) : 0.15;
    const barHeight = amplitude * H * (0.8 + 0.2 * Math.sin(i + time));
    const x = i * (W / bars);
    const barWidth = (W / bars) * 0.8;
    // Color: blue if playing, gray if paused
    vctx.fillStyle = visActive ? "#0078ff" : "#aaa";
    vctx.fillRect(x, H - barHeight, barWidth, barHeight);
  }
}

function animateVisualizer() {
  drawVisualizer();
  visAnimId = requestAnimationFrame(animateVisualizer);
}

function startVisualizer() {
  visActive = true;
  if (!visAnimId) animateVisualizer();
}
function stopVisualizer() {
  visActive = false;
  drawVisualizer();
  if (visAnimId) {
    cancelAnimationFrame(visAnimId);
    visAnimId = null;
  }
}

// Responsivo ao redimensionar janela
window.addEventListener("resize", () => drawVisualizer());
drawVisualizer(); // Inicializa

function onYouTubeIframeAPIReady() {
  player = new YT.Player('player', {
    height: '1',
    width: '1',
    events: {
      'onReady': () => console.log("Player pronto!"),
      'onStateChange': onPlayerStateChange
    }
  });
}

function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.ENDED) {
    skip();
    stopVisualizer();
  }
  if (event.data === YT.PlayerState.PLAYING) {
    duration = player.getDuration();
    updateProgressBar();
    startProgressBarInterval();
    startVisualizer(); // visualizer ON
    const data = player.getVideoData();
    const dur = formatTime(duration);
    if (playlist[currentIndex]) {
      playlist[currentIndex].title = data.title;
      playlist[currentIndex].duration = dur;
      playlist[currentIndex].thumb = `https://img.youtube.com/vi/${playlist[currentIndex].id}/default.jpg`;
      updatePlaylistDisplay();
    }
    document.getElementById("time-duration").textContent = dur;
  }
  if (event.data === YT.PlayerState.PAUSED || event.data === YT.PlayerState.ENDED) {
    stopProgressBarInterval();
    stopVisualizer(); // visualizer OFF
  }
}

function extractVideoId(url) {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length === 11) ? match[2] : null;
}

function playSong(index) {
  if (index < 0 || index >= playlist.length) return;
  currentIndex = index;
  updatePlaylistDisplay();
  player.loadVideoById(playlist[index].id);
}

function updatePlaylistDisplay() {
  const container = document.getElementById("playlist");
  container.innerHTML = "";
  playlist.forEach((song, i) => {
    const div = document.createElement("div");
    div.className = "song" + (i === currentIndex ? " current" : "");
    div.onclick = () => playSong(i);

    const img = document.createElement("img");
    img.src = song.thumb || `https://img.youtube.com/vi/${song.id}/default.jpg`;

    const info = document.createElement("div");
    info.className = "info";

    const title = document.createElement("div");
    title.className = "title";
    title.textContent = song.title || "(Carregando t√≠tulo...)";

    const duration = document.createElement("div");
    duration.className = "duration";
    duration.textContent = song.duration || "";

    info.appendChild(title);
    info.appendChild(duration);

    div.appendChild(img);
    div.appendChild(info);
    container.appendChild(div);
  });
}

function formatTime(sec) {
  sec = Math.floor(sec);
  const m = Math.floor(sec / 60);
  const s = sec % 60;
  return `${m}:${s < 10 ? '0' : ''}${s}`;
}

function addSong(url) {
  const id = extractVideoId(url);
  if (!id) {
    alert("Link inv√°lido!");
    return;
  }
  playlist.push({ id, title: "(Carregando t√≠tulo...)", duration: "", thumb: `https://img.youtube.com/vi/${id}/default.jpg` });
  updatePlaylistDisplay();
  // S√≥ toca automaticamente se for a primeira m√∫sica
  if (playlist.length === 1) {
    playSong(0);
  }
}

function skip() {
  if (currentIndex + 1 < playlist.length) {
    playSong(currentIndex + 1);
  } else {
    player.stopVideo();
    document.getElementById("progress-filled").style.width = "0%";
    document.getElementById("time-current").textContent = "0:00";
    document.getElementById("time-duration").textContent = "0:00";
    stopProgressBarInterval();
    stopVisualizer();
    alert("Fim da playlist.");
  }
}

function prevSong() {
  if (currentIndex > 0) {
    playSong(currentIndex - 1);
  } else {
    alert("J√° est√° na primeira m√∫sica.");
  }
}

// ----------- Barra de Progresso -----------
function updateProgressBar() {
  if (!player || !duration) return;
  const current = player.getCurrentTime();
  const percent = duration ? (current / duration) * 100 : 0;
  document.getElementById("progress-filled").style.width = percent + "%";
  document.getElementById("time-current").textContent = formatTime(current);
}

function startProgressBarInterval() {
  stopProgressBarInterval();
  progressBarInterval = setInterval(() => {
    if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
      updateProgressBar();
    }
  }, 500);
}

function stopProgressBarInterval() {
  if (progressBarInterval) {
    clearInterval(progressBarInterval);
    progressBarInterval = null;
  }
}

document.getElementById("progress-bar").addEventListener("click", function(e) {
  if (!player || !duration) return;
  const rect = this.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const percent = x / rect.width;
  const seekTo = percent * duration;
  player.seekTo(seekTo, true);
  updateProgressBar();
});

// ----------- Bot√µes -----------
document.getElementById("btnAdd").onclick = () => {
  const url = document.getElementById("inputLink").value.trim();
  if (url) {
    addSong(url);
    document.getElementById("inputLink").value = "";
  }
};
document.getElementById("btnPlay").onclick = () => {
  if (player && playlist.length > 0) player.playVideo();
};
document.getElementById("btnPause").onclick = () => {
  if (player) player.pauseVideo();
};
document.getElementById("btnSkip").onclick = skip;
document.getElementById("btnPrev").onclick = prevSong;
document.getElementById("btnStop").onclick = () => {
  if (player) player.stopVideo();
  playlist = [];
  currentIndex = 0;
  duration = 0;
  document.getElementById("progress-filled").style.width = "0%";
  document.getElementById("time-current").textContent = "0:00";
  document.getElementById("time-duration").textContent = "0:00";
  stopProgressBarInterval();
  stopVisualizer();
  updatePlaylistDisplay();
};
</script>

</body>
</html>
